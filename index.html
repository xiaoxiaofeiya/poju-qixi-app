<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=2.0, minimum-scale=1.0, viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <!-- 移动端优化 -->
    <meta name="HandheldFriendly" content="true">
    <meta name="MobileOptimized" content="width">
    <!-- iOS Safari 兼容性 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-touch-fullscreen" content="yes">
    <!-- 强制HTTPS重定向脚本 -->
    <script>
        if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            location.replace('https:' + window.location.href.substring(window.location.protocol.length));
        }
    </script>
    <title>AI破局七夕情缘 - 破局俱乐部专属APP</title>
    
    <!-- PWA配置 -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="破局七夕">
    <link rel="apple-touch-icon" href="icon-192.svg">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap');
        
        /* Fallback font stack for better mobile compatibility */
        @font-face {
            font-family: 'Noto Sans SC';
            src: local('PingFang SC'), local('Microsoft YaHei'), local('SimHei'), local('Arial');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans SC', 'PingFang SC', 'Microsoft YaHei', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 300% 300%;
            animation: gradientShift 8s ease infinite;
            min-height: 100vh;
            color: #333;
            position: relative;
            overflow-x: hidden;
            /* 优化移动端滚动 */
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 182, 193, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 1;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 2;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
            position: relative;
        }

        .header::before {
            content: '✨';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 3em;
            animation: sparkle 2s ease-in-out infinite alternate;
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 15px;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
            background: linear-gradient(45deg, #fff, #ffeaa7, #fdcb6e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            letter-spacing: 2px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.95;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .header .subtitle {
            font-size: 1em;
            opacity: 0.8;
            font-style: italic;
        }

        @keyframes sparkle {
            0% { transform: translateX(-50%) scale(1); }
            100% { transform: translateX(-50%) scale(1.2); }
        }

        .card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 25px;
            padding: 40px;
            margin-bottom: 25px;
            box-shadow: 
                0 15px 35px rgba(0,0,0,0.1),
                0 5px 15px rgba(0,0,0,0.05),
                inset 0 1px 0 rgba(255,255,255,0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.3);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #f093fb);
            border-radius: 25px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover::before {
            opacity: 0.7;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 
                0 25px 50px rgba(0,0,0,0.15),
                0 10px 25px rgba(0,0,0,0.1);
        }

        /* 添加更多装饰元素和动画效果 */
        .floating-hearts {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }

        .heart {
            position: absolute;
            color: rgba(255, 182, 193, 0.6);
            font-size: 1.2em;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }

        .form-group {
            margin-bottom: 30px;
            position: relative;
            opacity: 0;
            transform: translateY(20px);
            animation: slideInUp 0.6s ease-out forwards;
        }

        .form-group:nth-child(1) { animation-delay: 0.1s; }
        .form-group:nth-child(2) { animation-delay: 0.2s; }
        .form-group:nth-child(3) { animation-delay: 0.3s; }
        .form-group:nth-child(4) { animation-delay: 0.4s; }
        .form-group:nth-child(5) { animation-delay: 0.5s; }
        .form-group:nth-child(6) { animation-delay: 0.6s; }
        .form-group:nth-child(7) { animation-delay: 0.7s; }
        .form-group:nth-child(8) { animation-delay: 0.8s; }

        @keyframes slideInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-group input, 
        .form-group select, 
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus, 
        .form-group select:focus, 
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 18px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 200% 200%;
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 25px;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 
                0 8px 25px rgba(102, 126, 234, 0.3),
                inset 0 1px 0 rgba(255,255,255,0.2);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px);
            background-position: 100% 100%;
            box-shadow: 
                0 15px 35px rgba(102, 126, 234, 0.4),
                0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .result-container {
            display: none;
            animation: fadeInScale 0.8s ease-out;
        }

        @keyframes fadeInScale {
            0% {
                opacity: 0;
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .love-letter {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 50%, #fd79a8 100%);
            border-radius: 20px;
            padding: 35px;
            margin: 25px 0;
            color: #2d3436;
            line-height: 2;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 10px 30px rgba(253, 121, 168, 0.3),
                inset 0 1px 0 rgba(255,255,255,0.6);
            border: 2px solid rgba(255,255,255,0.4);
        }

        .love-letter::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255,255,255,0.2) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(255,255,255,0.2) 0%, transparent 20%),
                radial-gradient(circle at 50% 50%, rgba(253,121,168,0.1) 0%, transparent 30%);
            pointer-events: none;
        }

        .love-letter::after {
            content: "💕";
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 2.5em;
            opacity: 0.4;
            animation: heartbeat 2s ease-in-out infinite;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .fortune {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 50%, #d63031 10%);
            border-radius: 20px;
            padding: 35px;
            margin: 25px 0;
            color: #2d3436;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 10px 30px rgba(108, 92, 231, 0.2),
                inset 0 1px 0 rgba(255,255,255,0.6);
            border: 2px solid rgba(255,255,255,0.4);
        }

        .fortune::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(108,92,231,0.1) 0%, transparent 25%),
                radial-gradient(circle at 80% 70%, rgba(168,237,234,0.2) 0%, transparent 25%);
            pointer-events: none;
        }

        .fortune h3 {
            margin-bottom: 20px;
            color: #6c5ce7;
            font-size: 1.4em;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(108, 92, 231, 0.2);
        }

        .share-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .hidden {
            display: none;
        }

        .constellation-icon {
            font-size: 1.5em;
            margin-right: 8px;
        }

        .ai-tools {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        .ai-tool {
            background: rgba(102, 126, 234, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            color: #667eea;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .ai-tool:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        /* 加载动画 */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(102, 126, 234, 0.2);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 成功提示动画 */
        .success-message {
            display: none;
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0, 184, 148, 0.3);
            animation: successPulse 0.5s ease-out;
        }

        @keyframes successPulse {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* 优化移动端体验 */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
                margin: 0;
            }
            
            .header h1 {
                font-size: 2em;
                line-height: 1.2;
                margin-bottom: 10px;
            }
            
            .header p {
                font-size: 1em;
                margin-bottom: 5px;
            }
            
            .header .subtitle {
                font-size: 0.9em;
            }
            
            .card {
                padding: 20px;
                margin-bottom: 20px;
                border-radius: 20px;
            }

            .love-letter, .fortune {
                padding: 20px;
                border-radius: 15px;
                margin: 15px 0;
            }
            
            /* 移动端表单优化 */
            .form-group {
                margin-bottom: 25px;
            }
            
            .form-group label {
                font-size: 16px;
                margin-bottom: 10px;
                font-weight: 600;
            }
            
            .form-group input, 
            .form-group select, 
            .form-group textarea {
                font-size: 16px !important; /* 防止iOS缩放 */
                padding: 15px !important;
                border-radius: 12px;
                border: 2px solid #e2e8f0 !important;
                -webkit-appearance: none !important;
                appearance: none !important;
                min-height: 50px;
                box-sizing: border-box !important;
                /* Android修复 */
                background-color: white !important;
                color: #333 !important;
                /* 确保输入框可交互 */
                -webkit-user-select: text !important;
                user-select: text !important;
                -webkit-touch-callout: default !important;
                touch-action: manipulation !important;
                pointer-events: auto !important;
                z-index: 1000 !important;
                position: relative !important;
                /* 移除任何可能的遮罩 */
                outline: none !important;
                -webkit-tap-highlight-color: rgba(0,0,0,0) !important;
            }
            
            .form-group select {
                background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 5"><path fill="%23666" d="M2 0L0 2h4zm0 5L0 3h4z"/></svg>');
                background-repeat: no-repeat;
                background-position: right 15px center;
                background-size: 12px;
                padding-right: 40px;
            }
            
            .form-group textarea {
                min-height: 100px;
                resize: vertical;
                line-height: 1.5;
            }
            
            /* 按钮移动端优化 */
            .btn {
                font-size: 16px;
                padding: 18px 20px;
                border-radius: 12px;
                min-height: 56px;
                margin-top: 20px;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
                /* 确保按钮可点击 */
                cursor: pointer;
                pointer-events: auto;
                position: relative;
                z-index: 10;
                /* 修复移动端点击问题 */
                -webkit-user-select: none;
                user-select: none;
                display: block;
                width: 100%;
                border: none;
                outline: none;
            }
            
            /* 图片预览移动端优化 */
            #previewImage {
                max-width: 100%;
                height: auto;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            }
            
            .share-card {
                padding: 15px;
                margin: 15px 0;
                border-radius: 15px;
            }
            
            /* 移动端动画性能优化 */
            .heart {
                will-change: transform;
                transform: translateZ(0);
            }
        }

        /* 小屏手机优化 */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .card {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .form-group input, 
            .form-group select, 
            .form-group textarea {
                padding: 12px;
                font-size: 16px;
            }
            
            .btn {
                padding: 16px 18px;
                font-size: 15px;
            }
            
            .love-letter, .fortune {
                padding: 15px;
                font-size: 16px;
                line-height: 1.8;
            }
        }

        /* 横屏移动端优化 */
        @media (max-height: 500px) and (orientation: landscape) {
            .header {
                margin-bottom: 20px;
            }
            
            .header h1 {
                font-size: 1.5em;
                margin-bottom: 5px;
            }
            
            .floating-hearts {
                display: none; /* 横屏时隐藏装饰，节省性能 */
            }
        }

        /* 全局触摸优化 - 修复Android问题 */
        * {
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        }

        /* 只对非输入元素禁用选择，输入元素保持默认 */
        body, div, span, h1, h2, h3, p, button {
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        /* 表单元素强制启用交互 */
        input, textarea, select {
            -webkit-user-select: text !important;
            user-select: text !important;
            -webkit-touch-callout: default !important;
            /* Android兼容性修复 */
            -webkit-appearance: none !important;
            appearance: none !important;
            background-color: white !important;
            /* 确保可点击 */
            pointer-events: auto !important;
            /* 移除所有可能的覆盖层影响 */
            position: relative !important;
            z-index: 999 !important;
        }

        /* 确保点击区域足够大 */
        button, .btn {
            min-height: 44px;
            min-width: 44px;
            touch-action: manipulation;
        }

        /* 防止iOS safari底部条遮挡 */
        @supports(padding: max(0px)) {
            body {
                padding-bottom: max(20px, env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 浮动装饰元素 -->
        <div class="floating-hearts" id="floatingHearts"></div>
        
        <div class="header">
            <h1>AI破局七夕情缘生成器</h1>
            <p>🎁 献给破局俱乐部的七夕礼物 🎁</p>
            <p class="subtitle">探索你与AI的专属缘分，书写独属于你的AI情书 ✨</p>
        </div>

        <div class="card" id="inputForm">
            <h2 style="text-align: center; margin-bottom: 25px; color: #667eea;">💕 写给破局俱乐部的七夕情书 💕</h2>
            
            <div class="form-group">
                <label for="constellation">🌟 你的星座</label>
                <select id="constellation" required>
                    <option value="">请选择你的星座</option>
                    <option value="aries">白羊座 ♈</option>
                    <option value="taurus">金牛座 ♉</option>
                    <option value="gemini">双子座 ♊</option>
                    <option value="cancer">巨蟹座 ♋</option>
                    <option value="leo">狮子座 ♌</option>
                    <option value="virgo">处女座 ♍</option>
                    <option value="libra">天秤座 ♎</option>
                    <option value="scorpio">天蝎座 ♏</option>
                    <option value="sagittarius">射手座 ♐</option>
                    <option value="capricorn">摩羯座 ♑</option>
                    <option value="aquarius">水瓶座 ♒</option>
                    <option value="pisces">双鱼座 ♓</option>
                </select>
            </div>

            <div class="form-group">
                <label for="nickname">💫 称呼/昵称</label>
                <input type="text" id="nickname" placeholder="你希望如何称呼？（如：小李、阿明等）" required>
            </div>

            <div class="form-group">
                <label for="joinTime">❤️ 加入俱乐部的时间</label>
                <input type="text" id="joinTime" placeholder="例如：2023年3月、今年春天等" required>
            </div>

            <div class="form-group">
                <label for="unforgettableMemory">🎆 最难忘的俱乐部活动/内容</label>
                <textarea id="unforgettableMemory" placeholder="印象最深的一次AI大航海、某个精彩分享、或者某个难忘的时刻..." required></textarea>
            </div>

            <div class="form-group">
                <label for="biggestChange">✨ 俱乐部带给我的最大改变</label>
                <textarea id="biggestChange" placeholder="技能提升、认知改变、结识朋友、副业变现等..." required></textarea>
            </div>

            <div class="form-group">
                <label for="confessionWords">💕 想对俱乐部说的话</label>
                <textarea id="confessionWords" placeholder="你最想对破局俱乐部说的心里话，感谢、祝愿、期待..." required></textarea>
            </div>

            <div class="form-group">
                <label for="letterStyle">💝 情书风格</label>
                <select id="letterStyle" required>
                    <option value="">选择你喜欢的风格</option>
                    <option value="romantic">浪漫表白款 - 深情告白</option>
                    <option value="grateful">感恩感谢款 - 真诚感谢</option>
                    <option value="inspiring">激励加油款 - 共同成长</option>
                </select>
            </div>

            <div class="loading" id="loadingDiv">
                <div class="spinner"></div>
                <p style="margin-top: 15px;">正在为你生成专属AI情书...</p>
            </div>

            <button class="btn" onclick="generateLoveLetter()" id="generateBtn">
                🎨 生成我的AI情书 ✨
            </button>
            
            <!-- 移动端调试按钮 -->
            <button class="btn" onclick="testMobileClick()" id="debugBtn" style="background: #e74c3c; margin-top: 10px; display: none;">
                🔧 移动端测试按钮
            </button>
        </div>

        <div class="result-container" id="resultContainer">
            <div class="card">
                <div class="love-letter" id="loveLetter">
                    <!-- 生成的情书内容 -->
                </div>
                
                <div class="fortune" id="fortune">
                    <!-- 生成的运势内容 -->
                </div>

                <div class="share-card" id="shareCard">
                    <h3 style="color: #667eea; margin-bottom: 15px;">✨ 生成分享卡片 ✨</h3>
                    <p style="margin-bottom: 20px;">生成精美的卡片分享到破局俱乐部~</p>
                    
                    <!-- Canvas 用于生成图片 -->
                    <canvas id="shareCanvas" width="600" height="800" style="display: none;"></canvas>
                    <canvas id="loveLetterCanvas" width="600" height="1200" style="display: none;"></canvas>
                    
                    <!-- 预览区域 -->
                    <div id="cardPreview" style="display: none; margin-bottom: 20px; text-align: center;">
                        <img id="previewImage" alt="破局俱乐部七夕表白卡预览" style="max-width: 100%; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.2);" />
                    </div>
                    
                    <button class="btn" onclick="generateShareImage()" style="margin-bottom: 15px;">
                        🎨 生成表白卡片
                    </button>
                    <button class="btn" onclick="generateLoveLetterImage()" style="margin-bottom: 15px; background: #fd79a8;">
                        📜 生成情书长图
                    </button>
                    <button class="btn" onclick="downloadImage()" id="downloadBtn" style="display: none; background: #00cec9; margin-bottom: 10px;">
                        📱 下载卡片
                    </button>
                    <button class="btn" onclick="downloadLoveLetterImage()" id="downloadLetterBtn" style="display: none; background: #6c5ce7; margin-bottom: 10px;">
                        📱 下载情书
                    </button>
                    <button class="btn" onclick="generateAnother()" style="background: #fd79a8;">
                        🔄 再生成一份
                    </button>
                    
                    <!-- PWA安装按钮 -->
                    <button class="btn" id="installBtn" style="display: none; background: #00b894; margin-top: 15px;">
                        📱 安装到手机
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- PWA安装提示 -->
    <div id="installPrompt" style="display: none; position: fixed; bottom: 20px; left: 20px; right: 20px; background: linear-gradient(135deg, #00b894, #00cec9); color: white; padding: 15px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,184,148,0.3); z-index: 1000; text-align: center;">
        <p style="margin: 0 0 10px 0; font-weight: 600;">📱 安装APP到手机桌面</p>
        <p style="margin: 0 0 15px 0; font-size: 14px; opacity: 0.9;">享受更好的使用体验，可离线使用</p>
        <button onclick="installApp()" style="background: white; color: #00b894; border: none; padding: 8px 15px; border-radius: 8px; font-weight: 600; margin-right: 10px; cursor: pointer;">立即安装</button>
        <button onclick="dismissInstall()" style="background: transparent; color: white; border: 1px solid rgba(255,255,255,0.5); padding: 8px 15px; border-radius: 8px; cursor: pointer;">稍后</button>
    </div>

    <!-- PWA脚本 -->
    <script>
        // PWA安装相关 - 增强版本
        let deferredPrompt;
        let installPromptShown = false;
        
        // 检测设备类型
        function getMobileOperatingSystem() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                return "iOS";
            }
            if (/android/i.test(userAgent)) {
                return "Android";
            }
            return "unknown";
        }
        
        // 检测是否已安装
        function isInStandaloneMode() {
            return (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || 
                   (window.navigator && window.navigator.standalone) ||
                   document.referrer.includes('android-app://');
        }
        
        // 显示安装提示
        function showInstallPrompt() {
            const installPrompt = document.getElementById('installPrompt');
            if (installPrompt && !installPromptShown && !isInStandaloneMode()) {
                installPrompt.style.display = 'block';
                installPromptShown = true;
                console.log('显示PWA安装提示');
            }
        }
        
        // beforeinstallprompt 事件处理
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('beforeinstallprompt 事件触发');
            e.preventDefault();
            deferredPrompt = e;
            
            // 立即显示安装提示
            setTimeout(() => {
                showInstallPrompt();
            }, 1000);
        });
        
        // 安装APP - 增强调试版本
        function installApp() {
            const os = getMobileOperatingSystem();
            console.log('点击安装按钮，检测系统:', os);
            console.log('deferredPrompt状态:', deferredPrompt);
            
            if (deferredPrompt) {
                console.log('使用deferredPrompt安装');
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    console.log('用户选择:', choiceResult.outcome);
                    if (choiceResult.outcome === 'accepted') {
                        console.log('用户接受了安装');
                        alert('安装成功！请查看主屏幕');
                    } else {
                        console.log('用户拒绝了安装');
                    }
                    deferredPrompt = null;
                    document.getElementById('installPrompt').style.display = 'none';
                }).catch(err => {
                    console.error('安装过程出错:', err);
                    showManualInstallInstructions(os);
                });
            } else {
                console.log('deferredPrompt不可用，显示手动安装指引');
                showManualInstallInstructions(os);
            }
        }
        
        // 显示手动安装指引
        function showManualInstallInstructions(os) {
            let message = '';
            let title = '手动安装指引';
            
            if (os === 'iOS') {
                message = `请按以下步骤操作：
1. 点击Safari底部的"分享"按钮 📤
2. 滑动找到"添加到主屏幕" 📱
3. 点击"添加"确认安装

提示：如果没有看到"添加到主屏幕"选项，说明网站不满足PWA安装条件。`;
            } else if (os === 'Android') {
                message = `请按以下步骤操作：
1. 点击浏览器右上角的菜单按钮 ⋮
2. 选择"添加到主屏幕"或"安装应用" 📱
3. 确认安装

注意：不同的Android浏览器选项位置可能略有不同。`;
            } else {
                message = `请按以下步骤操作：
1. 点击浏览器地址栏右侧的安装图标
2. 或通过浏览器菜单选择"安装应用"
3. 确认安装`;
            }
            
            // 创建自定义弹窗而不是alert
            showCustomInstallDialog(title, message);
        }
        
        // 自定义安装指引弹窗
        function showCustomInstallDialog(title, message) {
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 20px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 90%;
                text-align: left;
            `;
            
            dialog.innerHTML = `
                <h3 style="color: #667eea; margin-bottom: 15px;">${title}</h3>
                <div style="white-space: pre-line; line-height: 1.6; margin-bottom: 20px;">${message}</div>
                <button onclick="this.parentNode.remove()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; float: right;">我知道了</button>
            `;
            
            document.body.appendChild(dialog);
            
            // 3秒后自动关闭
            setTimeout(() => {
                if (dialog.parentNode) {
                    dialog.remove();
                }
            }, 8000);
        }
        
        function dismissInstall() {
            document.getElementById('installPrompt').style.display = 'none';
            installPromptShown = true;
        }
        
        // 页面加载后的初始化 - 增强调试版本
        document.addEventListener('DOMContentLoaded', function() {
            const os = getMobileOperatingSystem();
            console.log('=== PWA调试信息 ===');
            console.log('检测到设备:', os);
            console.log('User Agent:', navigator.userAgent);
            console.log('是否为独立模式:', isInStandaloneMode());
            console.log('是否支持Service Worker:', 'serviceWorker' in navigator);
            console.log('当前协议:', location.protocol);
            console.log('当前域名:', location.hostname);
            
            // 检查PWA安装条件
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                console.log('✅ PWA基础条件满足');
            } else {
                console.log('❌ PWA基础条件不满足');
            }
            
            // 修复移动端按钮点击问题
            setupMobileClickFix();
            
            // 如果是移动设备且未安装，显示安装提示
            if ((os === 'iOS' || os === 'Android') && !isInStandaloneMode()) {
                console.log('准备显示安装提示...');
                // 延迟显示，让用户先看到内容
                setTimeout(() => {
                    console.log('显示安装提示');
                    showInstallPrompt();
                }, 3000);
            } else {
                console.log('跳过安装提示 - 设备:', os, '独立模式:', isInStandaloneMode());
            }
        });
        
        // 移动端测试函数
        function testMobileClick() {
            console.log('移动端测试按钮被点击！');
            alert('移动端点击测试成功！🎉\n\n如果你看到这个弹窗，说明按钮点击功能正常。');
        }
        
        // 修复移动端按钮点击问题
        function setupMobileClickFix() {
            console.log('设置移动端点击修复...');
            
            // 检测移动设备并显示调试按钮
            const os = getMobileOperatingSystem();
            if (os === 'iOS' || os === 'Android') {
                const debugBtn = document.getElementById('debugBtn');
                if (debugBtn) {
                    debugBtn.style.display = 'block';
                    console.log('显示移动端调试按钮');
                }
            }
            
            // 获取生成按钮
            const generateBtn = document.getElementById('generateBtn');
            if (generateBtn) {
                console.log('找到生成按钮，添加事件监听器');
                
                // 移除可能阻止点击的样式
                generateBtn.style.pointerEvents = 'auto';
                generateBtn.style.zIndex = '9999';
                
                // 添加多重事件监听
                generateBtn.addEventListener('click', function(e) {
                    console.log('按钮被点击了！');
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // 检查script.js是否已加载
                    if (typeof generateLoveLetter === 'function') {
                        console.log('调用generateLoveLetter函数');
                        generateLoveLetter();
                    } else {
                        console.error('generateLoveLetter函数不存在！检查script.js是否加载');
                        alert('生成函数加载失败，请检查网络连接并刷新页面重试');
                        
                        // 尝试重新加载script.js
                        const script = document.createElement('script');
                        script.src = './script.js';
                        script.onload = () => {
                            console.log('script.js重新加载成功');
                            if (typeof generateLoveLetter === 'function') {
                                generateLoveLetter();
                            }
                        };
                        script.onerror = () => {
                            console.error('script.js重新加载失败');
                        };
                        document.head.appendChild(script);
                    }
                }, { passive: false });
                
                // 移动端添加touch事件
                generateBtn.addEventListener('touchstart', function(e) {
                    console.log('触摸开始');
                    generateBtn.style.backgroundColor = '#5a67d8';
                }, { passive: true });
                
                generateBtn.addEventListener('touchend', function(e) {
                    console.log('触摸结束，触发点击');
                    setTimeout(() => {
                        generateBtn.style.backgroundColor = '';
                    }, 150);
                }, { passive: true });
                
            } else {
                console.error('未找到生成按钮！');
            }
            
            // 检查所有按钮
            const allButtons = document.querySelectorAll('.btn, button');
            console.log('找到', allButtons.length, '个按钮');
            
            allButtons.forEach((btn, index) => {
                console.log('按钮', index, ':', btn.textContent.trim().substring(0, 20));
                // 确保所有按钮都可点击
                btn.style.pointerEvents = 'auto';
                btn.style.position = 'relative';
                btn.style.zIndex = '1000';
            });
        }
        
        // ========== 内置生成函数（避免外部文件加载失败） ==========
        
        // 简化的星座数据
        const constellationData = {
            aries: { name: '白羊座', icon: '♈', personality: '勇敢直率，敢于挑战', clubFit: '破局先锋', matchPercent: 95 },
            taurus: { name: '金牛座', icon: '♉', personality: '踏实稳重，注重品质', clubFit: '技能专家', matchPercent: 88 },
            gemini: { name: '双子座', icon: '♊', personality: '聪明多变，善于学习', clubFit: '学习达人', matchPercent: 92 },
            cancer: { name: '巨蟹座', icon: '♋', personality: '温和体贴，重视关系', clubFit: '社群建设者', matchPercent: 90 },
            leo: { name: '狮子座', icon: '♌', personality: '自信大方，天生领袖', clubFit: '破局领袖', matchPercent: 96 },
            virgo: { name: '处女座', icon: '♍', personality: '细致完美，追求精确', clubFit: '质量管控官', matchPercent: 89 },
            libra: { name: '天秤座', icon: '♎', personality: '优雅平衡，善于协调', clubFit: '关系协调员', matchPercent: 87 },
            scorpio: { name: '天蝎座', icon: '♏', personality: '深沉专注，洞察力强', clubFit: '策略大师', matchPercent: 94 },
            sagittarius: { name: '射手座', icon: '♐', personality: '自由乐观，勇于探索', clubFit: '探索先驱', matchPercent: 91 },
            capricorn: { name: '摩羯座', icon: '♑', personality: '务实进取，目标明确', clubFit: '目标达成者', matchPercent: 93 },
            aquarius: { name: '水瓶座', icon: '♒', personality: '创新独立，思维超前', clubFit: 'AI创新者', matchPercent: 97 },
            pisces: { name: '双鱼座', icon: '♓', personality: '感性浪漫，富有想象', clubFit: '创意设计师', matchPercent: 86 }
        };

        // 简化的情书模板
        const letterTemplates = {
            romantic: {
                opening: [
                    '亲爱的破局俱乐部，从{joinTime}与你相遇的那一刻起，我就知道找到了属于自己的地方...',
                    '最爱的破局大家庭，自从{joinTime}加入你以来，我的生活发生了翻天覆地的变化...'
                ],
                body: [
                    '还记得{unforgettableMemory}吗？那一刻我深深被震撼了，原来学习可以如此有趣。',
                    '在这里，{biggestChange}，让我重新认识了自己的潜力。',
                    '{confessionWords}',
                    '感谢你给了我一个全新的世界，让我在AI的海洋中自由遨游。'
                ],
                ending: [
                    '愿我们一起在破局的道路上越走越远，创造属于我们的传奇！❤️',
                    '此生有幸遇见你，破局俱乐部，我爱你！💕'
                ]
            },
            grateful: {
                opening: [
                    '感恩遇见破局俱乐部，{joinTime}那个决定改变了我的人生轨迹...',
                    '亲爱的破局家人们，{joinTime}的相遇是我今年最正确的决定...'
                ],
                body: [
                    '特别感谢{unforgettableMemory}，那个经历让我明白了什么叫做真正的成长。',
                    '这段时间{biggestChange}，我发现自己变得更加自信和强大。',
                    '{confessionWords}',
                    '每一次的学习都是一次蜕变，每一个伙伴都是珍贵的财富。'
                ],
                ending: [
                    '感谢每一位老师和同学的陪伴，让这个七夕变得如此特别！🙏',
                    '破局俱乐部，感谢你成就了更好的我！✨'
                ]
            },
            inspiring: {
                opening: [
                    '破局俱乐部的伙伴们，{joinTime}我们相遇，从此踏上了共同成长的道路...',
                    '我的破局战友们，{joinTime}开始的这段旅程充满了挑战与收获...'
                ],
                body: [
                    '通过{unforgettableMemory}，我学会了面对困难时的坚持与勇气。',
                    '{biggestChange}，这让我看到了无限的可能性。',
                    '{confessionWords}',
                    '我们一起学习，一起进步，一起创造未来。'
                ],
                ending: [
                    '让我们继续携手前行，在AI的世界里闯出一片天地！🚀',
                    '破局俱乐部，我们一起加油，未来可期！💪'
                ]
            }
        };

        // 内置生成函数
        function generateLoveLetter() {
            console.log('内置generateLoveLetter函数被调用');
            
            // 获取用户输入
            const constellation = document.getElementById('constellation').value;
            const nickname = document.getElementById('nickname').value;
            const joinTime = document.getElementById('joinTime').value;
            const unforgettableMemory = document.getElementById('unforgettableMemory').value;
            const biggestChange = document.getElementById('biggestChange').value;
            const confessionWords = document.getElementById('confessionWords').value;
            const letterStyle = document.getElementById('letterStyle').value;

            // 验证输入
            if (!constellation || !nickname || !joinTime || !unforgettableMemory || !biggestChange || !confessionWords || !letterStyle) {
                alert('请填写所有必填项目哦～ 😊');
                return;
            }

            // 显示加载动画
            const loadingDiv = document.getElementById('loadingDiv');
            if (loadingDiv) {
                loadingDiv.style.display = 'block';
            }
            
            // 模拟加载时间
            setTimeout(() => {
                // 获取星座数据
                const constellationInfo = constellationData[constellation];
                const template = letterTemplates[letterStyle];

                // 随机选择模板片段
                const opening = template.opening[Math.floor(Math.random() * template.opening.length)];
                const body = template.body.join('\n\n');
                const ending = template.ending[Math.floor(Math.random() * template.ending.length)];

                // 替换变量
                let loveLetter = (opening + '\n\n' + body + '\n\n' + ending)
                    .replace(/{joinTime}/g, joinTime)
                    .replace(/{unforgettableMemory}/g, unforgettableMemory)
                    .replace(/{biggestChange}/g, biggestChange)
                    .replace(/{confessionWords}/g, confessionWords)
                    .replace(/{nickname}/g, nickname);

                // 生成运势内容
                const fortuneContent = `
                    <h3>🔮 ${nickname}的破局俱乐部运势</h3>
                    <div style="margin: 20px 0;">
                        <h4 style="color: #6c5ce7; margin-bottom: 10px;">
                            ${constellationInfo.icon} ${constellationInfo.name} × 破局俱乐部
                        </h4>
                        <div style="font-size: 24px; font-weight: bold; color: #e17055; margin: 10px 0;">
                            俱乐部契合度：${constellationInfo.matchPercent}%
                        </div>
                        <p style="margin-bottom: 15px;">
                            <strong>性格特质：</strong>${constellationInfo.personality}
                        </p>
                        <p style="margin-bottom: 15px;">
                            <strong>俱乐部身份：</strong>${constellationInfo.clubFit}
                        </p>
                    </div>
                    <div style="margin: 20px 0; text-align: center; padding: 15px; background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%); border-radius: 10px;">
                        <p style="margin-bottom: 10px;"><strong>💰 破局财运提示</strong></p>
                        <p>下半年AI变现黄金期将在9-11月到来，现在正是在俱乐部积累技能的最佳时机！</p>
                    </div>
                    <div style="margin: 20px 0; text-align: center; padding: 15px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); border-radius: 10px;">
                        <p style="margin-bottom: 10px;"><strong>❤️ 七夕特别祝福</strong></p>
                        <p>愿你在破局俱乐部找到志同道合的伙伴，一起在AI的世界里创造属于我们的传奇故事！</p>
                    </div>
                `;

                // 显示结果
                document.getElementById('loveLetter').innerHTML = `
                    <h2 style="text-align: center; margin-bottom: 25px; color: #e17055; font-size: 1.8em;">
                        💕 ${nickname}的破局情书 💕
                    </h2>
                    <div style="line-height: 2.2; font-size: 17px; text-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                        ${loveLetter.replace(/\n/g, '<br><br>')}
                    </div>
                    <p style="text-align: right; margin-top: 25px; font-style: italic; color: #636e72; font-size: 16px;">
                        —— 来自${constellationInfo.name}的${nickname} ${constellationInfo.icon}
                    </p>
                `;

                document.getElementById('fortune').innerHTML = fortuneContent;

                // 隐藏加载，显示结果
                if (loadingDiv) {
                    loadingDiv.style.display = 'none';
                }
                document.getElementById('inputForm').style.display = 'none';
                document.getElementById('resultContainer').style.display = 'block';

                // 滚动到结果区域
                setTimeout(() => {
                    document.getElementById('resultContainer').scrollIntoView({ behavior: 'smooth' });
                }, 100);
                
                alert('✨ 你的破局情书已生成！');
            }, 2000);
        }
        
        // 重新生成函数
        function generateAnother() {
            document.getElementById('resultContainer').style.display = 'none';
            document.getElementById('inputForm').style.display = 'block';
            
            // 滚动到表单
            document.getElementById('inputForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        // 其他简化函数
        function generateShareImage() {
            alert('分享功能暂时不可用，请截图保存内容 📱');
        }
        
        function generateLoveLetterImage() {
            alert('长图生成功能暂时不可用，请截图保存内容 📷');
        }
        
        function downloadImage() {
            alert('下载功能暂时不可用，请截图保存内容 💾');
        }
        
        function downloadLoveLetterImage() {
            alert('下载功能暂时不可用，请截图保存内容 💾');
        }
        
        // ==========================================================
        
        // 注册Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => {
                    console.log('SW注册成功:', registration);
                    
                    // SW注册成功后，如果还没有显示安装提示，则显示
                    if (!installPromptShown && !isInStandaloneMode()) {
                        setTimeout(() => {
                            showInstallPrompt();
                        }, 5000);
                    }
                })
                .catch(error => {
                    console.log('SW注册失败:', error);
                    // 即使SW注册失败，也尝试显示安装提示
                    if (!installPromptShown && !isInStandaloneMode()) {
                        setTimeout(() => {
                            showInstallPrompt();
                        }, 6000);
                    }
                });
        } else {
            console.log('浏览器不支持Service Worker');
            // 不支持SW也显示安装提示
            if (!installPromptShown && !isInStandaloneMode()) {
                setTimeout(() => {
                    showInstallPrompt();
                }, 4000);
            }
        }
    </script>
    
    <script src="script.js"></script>
</body>
</html>